

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head><!-- hexo injector head_begin start -->
<script>
(function() {
    var userLang = navigator.language || navigator.userLanguage;
    if (userLang && userLang.startsWith('zh')) {
        document.documentElement.setAttribute('lang', 'zh-CN');
        window.addEventListener('DOMContentLoaded', function() {
            // 1. Handle article page title and H1
            if (window._zh_title && window._en_title) {
                // Precisely detect: find English title in current title and replace with Chinese
                if (document.title.includes(window._en_title)) {
                    document.title = document.title.replace(window._en_title, window._zh_title);
                } else {
                    // Fallback: if theme handles title specially (e.g., truncation), replace directly
                    document.title = window._zh_title;
                }
                // Replace article page h1 title
                // Consider different theme selectors, find first h1 tag for replacement
                var h1 = document.querySelector('h1');
                if (h1 && window._zh_title) {
                    h1.textContent = window._zh_title;
                }
            }
            // 2. Replace all title elements with data-zh-title and data-en-title attributes on homepage or list pages
            var titleElements = document.querySelectorAll('[data-zh-title][data-en-title]');
            titleElements.forEach(function(el) {
                var zhTitle = el.getAttribute('data-zh-title');
                var enTitle = el.getAttribute('data-en-title');
                if (zhTitle && enTitle) {
                    // Replace element text content
                    if (el.textContent.trim() === enTitle.trim()) {
                        el.textContent = zhTitle;
                    }
                    // If it's a link element, also check its title attribute
                    if (el.hasAttribute('title') && el.getAttribute('title').trim() === enTitle.trim()) {
                        el.setAttribute('title', zhTitle);
                    }
                }
            });
            // 3. Replace article titles on homepage/list pages (using global title mapping)
            if (window._hexo_title_pairs && window._hexo_title_pairs.length > 0) {
                // Create English to Chinese mapping
                var titleMap = {};
                window._hexo_title_pairs.forEach(function(pair) {
                    titleMap[pair.en.trim()] = pair.zh;
                });
                // Helper function to replace article titles, supports exact match and contains match
                // Preserves child links when replacing text (assumes single link per title element)
                var replaceTitle = function(el) {
                    var text = el.textContent.trim();
                    var zhTitle = null;
                    var matchedEnTitle = null;
                    // Prefer exact match
                    if (titleMap[text]) {
                        zhTitle = titleMap[text];
                        matchedEnTitle = text;
                    } else {
                        // Try contains match (handle cases with extra spaces or child elements)
                        // Using indexOf for IE/older browser compatibility (this runs in browser context)
                        for (var enTitle in titleMap) {
                            if (text === enTitle || text.indexOf(enTitle) !== -1) {
                                // Only replace when text is highly similar to title (avoid false replacements)
                                if (text.length <= enTitle.length * 1.5) {
                                    zhTitle = titleMap[enTitle];
                                    matchedEnTitle = enTitle;
                                    break;
                                }
                            }
                        }
                    }
                    if (!zhTitle) return;
                    // Check if element contains a child link - if so, update link text to preserve hyperlink
                    var childLink = el.querySelector('a');
                    if (childLink) {
                        childLink.textContent = zhTitle;
                        // Also update title attribute if it matches the English title
                        if (childLink.hasAttribute('title') && childLink.getAttribute('title').trim() === matchedEnTitle) {
                            childLink.setAttribute('title', zhTitle);
                        }
                    } else {
                        el.textContent = zhTitle;
                    }
                };
                // Find title elements within article card/list containers (limit search scope for performance)
                var containers = document.querySelectorAll('main, article, .post, .posts, .post-list, .article-list, .card, .content, #content, #main');
                if (containers.length === 0) {
                    containers = [document.body];
                }
                containers.forEach(function(container) {
                    var titleSelectors = 'h1, h2, h3, .post-title, .article-title, .entry-title, .card-title, a[rel="bookmark"]';
                    var potentialTitleElements = container.querySelectorAll(titleSelectors);
                    potentialTitleElements.forEach(replaceTitle);
                });
            }
        });
    } else {
        document.documentElement.setAttribute('lang', 'en');
    }
})();
</script>
<!-- hexo injector head_begin end -->
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/favicon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tokisaki Galaxy">
  <meta name="keywords" content="blog">
  
    <meta name="description" content="从发现到解决IPProto-44，Openwrt或Linux上Tailscale与ZeroTier的路由冲突">
<meta property="og:type" content="article">
<meta property="og:title" content="Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt&#x2F;Linux (IPProto-44)">
<meta property="og:url" content="https://tokisaki.top/blog/resolve-route-conflict-zerotier-tailscale/index.html">
<meta property="og:site_name" content="Tokisaki Galaxy的博客">
<meta property="og:description" content="从发现到解决IPProto-44，Openwrt或Linux上Tailscale与ZeroTier的路由冲突">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-07-11T14:44:42.000Z">
<meta property="article:modified_time" content="2026-02-15T12:36:30.312Z">
<meta property="article:author" content="Tokisaki Galaxy">
<meta property="article:tag" content="OpenWrt">
<meta property="article:tag" content="Tailscale">
<meta property="article:tag" content="ZeroTier">
<meta property="article:tag" content="路由冲突">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44) - Tokisaki Galaxy的博客</title>

  <link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">



  <link  rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tokisaki.top","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":"enable","follow_dnt":false,"baidu":"91eeedd7b367cd070a600501df970843","google":{"measurement_id":"G-9YQEB4P3YS"},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"microsoftclarity":"eell8b38tb","gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?91eeedd7b367cd070a600501df970843";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-9YQEB4P3YS", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-9YQEB4P3YS');
        });
      }
    </script>
  

  

  

  


  
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "eell8b38tb");
    </script>



  
<!-- hexo injector head_end start -->
<style>
    .hexo-llm-zh { display: none; }
    .hexo-llm-en { display: block; }
    html[lang^="zh"] .hexo-llm-en { display: none !important; }
    html[lang^="zh"] .hexo-llm-zh { display: block !important; }
</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Tokisaki Galaxy的博客" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tokisaki Galaxy的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44)"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-11 22:44" pubdate>
          2025年7月11日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          152 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44)</h1>
            
            <div class="markdown-body">
              
              <script>
window._zh_title = "Openwrt或Linux上Tailscale与ZeroTier的路由冲突IPProto-44";
window._en_title = "Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44)";
</script>


<div class="hexo-llm-zh">


<p>因为有时候tailscale和zerotier都不太稳定，所以我在OpenWrt上同时使用了这两个VPN。平时主要用tailscale，zerotier作为应急有时候有奇效。</p>
<h3 id="问题的浮现：神秘的丢包日志"><a href="#问题的浮现：神秘的丢包日志" class="headerlink" title="问题的浮现：神秘的丢包日志"></a>问题的浮现：神秘的丢包日志</h3><p>一切始于一个看似无关的现象。在检查 OpenWrt 的系统日志时，我反复看到由 <code>tailscaled</code>（Tailscale 的守护进程）打印出的错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs log">Fri Jul 11 21:10:43 2025 daemon.err tailscaled[3274]: Drop: IPProto-44&#123;[fd7a:...] &gt; [fd7a:...]&#125; ... unknown-protocol-44<br>Fri Jul 11 21:10:53 2025 daemon.err tailscaled[3274]: [RATELIMIT] format(&quot;%s: %s %d %s\n%s&quot;) (8 dropped)<br></code></pre></td></tr></table></figure>

<p>日志显示 Tailscale 正在丢弃一种它不认识的协议（<code>IPProto-44</code>）的数据包，来源和目的地都是我网络内的设备。更奇怪的是，这些流量似乎与 Tailscale 本身无关。经过排查，元凶很快就锁定了——这些“异常流量”正是我的 ZeroTier 客户端为了连接其 Moon 中继服务器而发出的。</p>
<h3 id="深入分析，路由表？"><a href="#深入分析，路由表？" class="headerlink" title="深入分析，路由表？"></a>深入分析，路由表？</h3><p>为什么 ZeroTier 的流量会跑到 Tailscale 的地盘上呢？答案藏在路由规则里。</p>
<p>通过 SSH 登录到 OpenWrt 并执行 <code>ip rule show</code>，我们看到了问题的关键：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ImmortalWrt:~# ip rule show<br>0:      from all lookup <span class="hljs-built_in">local</span><br>...<br>5270:   from all lookup 52<br>32766:  from all lookup main<br>...<br></code></pre></td></tr></table></figure>

<p>Linux 的路由规则是按优先级（<code>prio</code>，数字越小优先级越高）执行的。这段输出告诉我们：<br>系统会先检查是不是发给路由器自己的流量 (<code>lookup local</code>)。如果不是，它会去检查一个优先级为 <code>5270</code> 的规则，这条规则说：“<strong>所有流量，都先去查阅路由表 <code>52</code></strong>”。路由表 <code>52</code> 是 Tailscale 安装时创建的专属路由表，里面只有通往其他 Tailscale 节点的路由。只有在路由表 <code>52</code> 里也找不到路时，流量才会继续往下，去查询优先级更低的 <code>main</code> 主路由表（我们正常的互联网出口就在这里）。</p>
<p><strong>结论显而易见：Tailscale 设置了一条过于“霸道”的高优先级规则，把所有从路由器发出的流量（包括 ZeroTier 的）都“劫持”了。当 ZeroTier 的特殊数据包被导向 Tailscale 的网络时，不认识它的 Tailscale 自然就选择丢弃。</strong></p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>要解决这个问题，我们不能粗暴地修改 Tailscale 的规则，而是应该为 ZeroTier 建立一条优先级更高的“专属通道”。</p>
<p><strong>我们的策略是：</strong> 创建一条新的路由规则，明确告诉系统：“<strong>凡是从 ZeroTier 虚拟网卡发出的流量，请直接走 <code>main</code> 主路由表</strong>”，并确保这条规则的优先级高于 Tailscale 的 <code>5270</code>。</p>
<h4 id="Openwrt脚本与使用"><a href="#Openwrt脚本与使用" class="headerlink" title="Openwrt脚本与使用"></a>Openwrt脚本与使用</h4><h5 id="第一步：（推荐）安装完整版-ip-工具"><a href="#第一步：（推荐）安装完整版-ip-工具" class="headerlink" title="第一步：（推荐）安装完整版 ip 工具"></a>第一步：（推荐）安装完整版 <code>ip</code> 工具</h5><p>OpenWrt 自带的 <code>ip</code> 命令功能可能不全。安装 <code>ip-full</code> 可以避免很多疑难杂症。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">opkg update<br>opkg install ip-full<br></code></pre></td></tr></table></figure>

<h5 id="第二步：创建服务脚本"><a href="#第二步：创建服务脚本" class="headerlink" title="第二步：创建服务脚本"></a>第二步：创建服务脚本</h5><p>使用 <code>vi</code> 或 <code>nano</code> 创建一个新的服务文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nano /etc/init.d/zerotier-policy-route<br></code></pre></td></tr></table></figure>

<p>将下面的完整脚本代码粘贴到你打开的文件中。</p>
<div class="note note-warning">
            <p>请根据你的实际情况，修改 <code>ZT_IFACE</code> 变量的值。你可以通过 <code>ifconfig | grep zt</code> 命令找到你的 ZeroTier 网卡名称。</p> 
          </div>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh /etc/rc.common</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This script creates policy routing rules for ZeroTier to coexist with Tailscale.</span><br><span class="hljs-comment"># It prevents ZeroTier&#x27;s traffic from being intercepted by Tailscale&#x27;s high-priority rule.</span><br><span class="hljs-comment"># Version 3: Intelligently handles IPv4 and IPv6 addresses.</span><br><span class="hljs-comment">#</span><br><br>START=99<br>STOP=15<br><br><span class="hljs-comment"># --- CONFIGURATION ---</span><br><span class="hljs-comment"># The name of your ZeroTier virtual network interface. Find it with `ifconfig | grep zt`.</span><br>ZT_IFACE=<span class="hljs-string">&quot;ztypia4gba&quot;</span><br><br><span class="hljs-comment"># The priority for the new routing rule. Must be lower (higher priority) than Tailscale&#x27;s (usually 5270).</span><br>RULE_PRIO=<span class="hljs-string">&quot;5260&quot;</span><br><br><span class="hljs-comment"># Tag for system log entries.</span><br>LOG_TAG=<span class="hljs-string">&quot;zerotier-policy-route&quot;</span><br><span class="hljs-comment"># --- END CONFIGURATION ---</span><br><br><span class="hljs-function"><span class="hljs-title">add_rules</span></span>() &#123;<br>    <span class="hljs-comment"># Get all global/unique IP addresses (v4 and v6), excluding link-local (fe80::) addresses.</span><br>    IP_LIST=$(ip addr show dev <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ZT_IFACE&#125;</span>&quot;</span> | grep -E <span class="hljs-string">&#x27;inet|inet6&#x27;</span> | grep -v <span class="hljs-string">&#x27; fe80::&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27;/&#x27;</span> -f1)<br><br>    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IP_LIST&#125;</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Warning: No usable IP addresses found on interface <span class="hljs-variable">$&#123;ZT_IFACE&#125;</span>.&quot;</span><br>        <span class="hljs-built_in">return</span><br>    <span class="hljs-keyword">fi</span><br><br>    <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;IP_LIST&#125;</span>; <span class="hljs-keyword">do</span><br>        <span class="hljs-comment"># Check if a rule for this IP already exists to avoid duplication.</span><br>        <span class="hljs-keyword">if</span> ! ip rule | grep -q <span class="hljs-string">&quot;from <span class="hljs-variable">$&#123;ip&#125;</span> lookup main&quot;</span>; <span class="hljs-keyword">then</span><br>            logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Adding rule for <span class="hljs-variable">$&#123;ip&#125;</span> with priority <span class="hljs-variable">$&#123;RULE_PRIO&#125;</span>.&quot;</span><br>            <br>            <span class="hljs-comment"># CRITICAL FIX: Use the &#x27;-6&#x27; flag for IPv6 addresses.</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> | grep -q <span class="hljs-string">&quot;:&quot;</span>; <span class="hljs-keyword">then</span><br>                ip -6 rule add from <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RULE_PRIO&#125;</span>&quot;</span><br>            <span class="hljs-keyword">else</span><br>                ip rule add from <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RULE_PRIO&#125;</span>&quot;</span><br>            <span class="hljs-keyword">fi</span><br>        <span class="hljs-keyword">else</span><br>            logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Rule for <span class="hljs-variable">$&#123;ip&#125;</span> already exists. Skipping.&quot;</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">remove_rules</span></span>() &#123;<br>    IP_LIST=$(ip addr show dev <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ZT_IFACE&#125;</span>&quot;</span> | grep -E <span class="hljs-string">&#x27;inet|inet6&#x27;</span> | grep -v <span class="hljs-string">&#x27; fe80::&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27;/&#x27;</span> -f1)<br>    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IP_LIST&#125;</span>&quot;</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">return</span>; <span class="hljs-keyword">fi</span><br><br>    <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;IP_LIST&#125;</span>; <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> ip rule | grep -q <span class="hljs-string">&quot;from <span class="hljs-variable">$&#123;ip&#125;</span> lookup main&quot;</span>; <span class="hljs-keyword">then</span><br>            logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Removing rule for <span class="hljs-variable">$&#123;ip&#125;</span>.&quot;</span><br><br>            <span class="hljs-comment"># Use the &#x27;-6&#x27; flag for deletion of IPv6 rules as well.</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> | grep -q <span class="hljs-string">&quot;:&quot;</span>; <span class="hljs-keyword">then</span><br>                ip -6 rule del from <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RULE_PRIO&#125;</span>&quot;</span><br>            <span class="hljs-keyword">else</span><br>                ip rule del from <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ip&#125;</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RULE_PRIO&#125;</span>&quot;</span><br>            <span class="hljs-keyword">fi</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">start</span></span>() &#123;<br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Service starting, applying rules...&quot;</span><br>    add_rules<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">stop</span></span>() &#123;<br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Service stopping, removing rules...&quot;</span><br>    remove_rules<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">reload</span></span>() &#123;<br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOG_TAG&#125;</span>&quot;</span> <span class="hljs-string">&quot;Service reloading...&quot;</span><br>    stop<br>    start<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="第三步：授权并启用服务"><a href="#第三步：授权并启用服务" class="headerlink" title="第三步：授权并启用服务"></a>第三步：授权并启用服务</h5><p>保存文件后，在终端执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 赋予脚本执行权限</span><br><span class="hljs-built_in">chmod</span> +x /etc/init.d/zerotier-policy-route<br><br><span class="hljs-comment"># 启用服务，让它开机自启</span><br>/etc/init.d/zerotier-policy-route <span class="hljs-built_in">enable</span><br><br><span class="hljs-comment"># 立即启动服务以应用规则</span><br>/etc/init.d/zerotier-policy-route start<br></code></pre></td></tr></table></figure>

<h5 id="第四步：验证成果"><a href="#第四步：验证成果" class="headerlink" title="第四步：验证成果"></a>第四步：验证成果</h5><p>执行 <code>ip rule show</code>，你将看到类似下面的输出，我们为 ZeroTier 的每个 IP 添加的 <code>5260</code> 规则已经稳稳地待在了 Tailscale 的规则之上。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">0</span>:      <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup <span class="hljs-keyword">local</span><br>...<br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> <span class="hljs-number">172.27</span><span class="hljs-number">.72</span><span class="hljs-number">.251</span> lookup main<br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> fddd:ec77:... lookup main<br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> fce1:<span class="hljs-number">9571</span>:... lookup main<br><span class="hljs-number">5270</span>:   <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup <span class="hljs-number">52</span><br>...<br></code></pre></td></tr></table></figure>

<h4 id="Linux服务器脚本与使用"><a href="#Linux服务器脚本与使用" class="headerlink" title="Linux服务器脚本与使用"></a>Linux服务器脚本与使用</h4><p>由于Openwrt出现这个提示，必然tailscale虚拟局域网中有另一台Linux服务器也安装了Tailscale和ZeroTier。我们可以将上面的脚本稍作修改，适用于其他Linux发行版。</p>
<h5 id="策略路由脚本"><a href="#策略路由脚本" class="headerlink" title="策略路由脚本"></a>策略路由脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> nano /usr/local/sbin/zerotier-policy-route.sh<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This script creates policy routing rules for all ZeroTier interfaces</span><br><span class="hljs-comment"># to coexist with Tailscale on a Debian-based system.</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-built_in">set</span> -e <span class="hljs-comment"># Exit immediately if a command exits with a non-zero status.</span><br><br><span class="hljs-comment"># --- CONFIGURATION ---</span><br><span class="hljs-comment"># The priority for the new routing rule.</span><br><span class="hljs-comment"># This MUST be a lower number (higher priority) than Tailscale&#x27;s rule (usually 5270).</span><br>RULE_PRIO=<span class="hljs-string">&quot;5260&quot;</span><br>LOG_TAG=<span class="hljs-string">&quot;zerotier-policy-route&quot;</span><br><span class="hljs-comment"># --- END CONFIGURATION ---</span><br><br><span class="hljs-comment"># Find all ZeroTier network interfaces (names starting with &#x27;zt&#x27;).</span><br><span class="hljs-comment"># We use `ip -o link show` for a stable, one-line-per-interface output.</span><br>ZT_INTERFACES=$(ip -o <span class="hljs-built_in">link</span> show | awk -F<span class="hljs-string">&#x27;: &#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | grep <span class="hljs-string">&#x27;^zt&#x27;</span>)<br><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$ZT_INTERFACES</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;No ZeroTier interfaces found. Exiting.&quot;</span><br>    <span class="hljs-built_in">exit</span> 0<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># Function to add rules for all found interfaces</span><br><span class="hljs-function"><span class="hljs-title">add_rules</span></span>() &#123;<br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;Applying policy routing rules...&quot;</span><br>    <span class="hljs-keyword">for</span> iface <span class="hljs-keyword">in</span> <span class="hljs-variable">$ZT_INTERFACES</span>; <span class="hljs-keyword">do</span><br>        <span class="hljs-comment"># Get all global/unique IP addresses (v4 and v6), excluding link-local (fe80::)</span><br>        IP_LIST=$(ip addr show dev <span class="hljs-string">&quot;<span class="hljs-variable">$iface</span>&quot;</span> | grep -E <span class="hljs-string">&#x27;inet|inet6&#x27;</span> | grep -v <span class="hljs-string">&#x27;fe80::&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27;/&#x27;</span> -f1)<br>        <br>        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$IP_LIST</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;No usable IP addresses on interface <span class="hljs-variable">$iface</span>. Skipping.&quot;</span><br>            <span class="hljs-built_in">continue</span><br>        <span class="hljs-keyword">fi</span><br><br>        <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> <span class="hljs-variable">$IP_LIST</span>; <span class="hljs-keyword">do</span><br>            <span class="hljs-comment"># Only add the rule if it doesn&#x27;t already exist.</span><br>            <span class="hljs-keyword">if</span> ! ip rule | grep -q <span class="hljs-string">&quot;from <span class="hljs-variable">$ip</span> lookup main&quot;</span>; <span class="hljs-keyword">then</span><br>                logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;Adding rule for <span class="hljs-variable">$ip</span> (on <span class="hljs-variable">$iface</span>) with priority <span class="hljs-variable">$RULE_PRIO</span>.&quot;</span><br>                <span class="hljs-comment"># Use the &#x27;-6&#x27; flag for IPv6 addresses.</span><br>                <span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> == *<span class="hljs-string">&quot;:&quot;</span>* ]]; <span class="hljs-keyword">then</span><br>                    ip -6 rule add from <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$RULE_PRIO</span>&quot;</span><br>                <span class="hljs-keyword">else</span><br>                    ip rule add from <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> lookup main prio <span class="hljs-string">&quot;<span class="hljs-variable">$RULE_PRIO</span>&quot;</span><br>                <span class="hljs-keyword">fi</span><br>            <span class="hljs-keyword">fi</span><br>        <span class="hljs-keyword">done</span><br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-comment"># Function to remove rules for all found interfaces</span><br><span class="hljs-function"><span class="hljs-title">remove_rules</span></span>() &#123;<br>    logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;Removing policy routing rules...&quot;</span><br>    <span class="hljs-comment"># We need to find all possible IPs that could have had rules.</span><br>    <span class="hljs-comment"># It&#x27;s safer to just try deleting any rule with our priority.</span><br>    <span class="hljs-comment"># This is simpler and more robust than tracking IPs.</span><br>    <span class="hljs-keyword">while</span> ip rule | grep -q <span class="hljs-string">&quot;prio <span class="hljs-variable">$RULE_PRIO</span>&quot;</span>; <span class="hljs-keyword">do</span><br>        <span class="hljs-comment"># Find the first rule with our priority and delete it. Loop until none are left.</span><br>        RULE_TO_DELETE=$(ip rule | grep <span class="hljs-string">&quot;prio <span class="hljs-variable">$RULE_PRIO</span>&quot;</span> | <span class="hljs-built_in">head</span> -n 1)<br>        logger -t <span class="hljs-string">&quot;<span class="hljs-variable">$LOG_TAG</span>&quot;</span> <span class="hljs-string">&quot;Deleting rule: <span class="hljs-variable">$RULE_TO_DELETE</span>&quot;</span><br>        <span class="hljs-comment"># Re-construct the delete command from the rule string.</span><br>        ip rule del <span class="hljs-variable">$&#123;RULE_TO_DELETE&#125;</span><br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-comment"># Main command logic</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br>    start)<br>        add_rules<br>        ;;<br>    stop)<br>        remove_rules<br>        ;;<br>    restart)<br>        remove_rules<br>        add_rules<br>        ;;<br>    *)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> &#123;start|stop|restart&#125;&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>        ;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-built_in">exit</span> 0<br></code></pre></td></tr></table></figure>
<p>最后记得加上权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> +x /usr/local/sbin/zerotier-policy-route.sh<br></code></pre></td></tr></table></figure>

<h4 id="自启动服务脚本"><a href="#自启动服务脚本" class="headerlink" title="自启动服务脚本"></a>自启动服务脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> nano /etc/systemd/system/zerotier-policy-route.service<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">[Unit]<br>Description=ZeroTier Policy Routing Fix <span class="hljs-keyword">for</span> Tailscale Coexistence<br>After=network-online.target<br>Wants=network-online.target<br>After=zerotier-one.service tailscaled.service<br><br>[Service]<br>Type=oneshot<br>RemainAfterExit=<span class="hljs-built_in">yes</span><br>ExecStart=/usr/local/sbin/zerotier-policy-route.sh start<br>ExecStop=/usr/local/sbin/zerotier-policy-route.sh stop<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<p>最后，要启动服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> zerotier-policy-route.service<br><span class="hljs-built_in">sudo</span> systemctl start zerotier-policy-route.service<br></code></pre></td></tr></table></figure>

<p>可以验证一下<code>ip rule show</code>，应该可以看到下面这样</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">0</span>:      <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup <span class="hljs-keyword">local</span><br><span class="hljs-number">5210</span>:   <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> fwmark <span class="hljs-number">0x80000</span><span class="hljs-operator">/</span><span class="hljs-number">0xff0000</span> lookup main<br><span class="hljs-number">5230</span>:   <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> fwmark <span class="hljs-number">0x80000</span><span class="hljs-operator">/</span><span class="hljs-number">0xff0000</span> lookup <span class="hljs-keyword">default</span><br><span class="hljs-number">5250</span>:   <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> fwmark <span class="hljs-number">0x80000</span><span class="hljs-operator">/</span><span class="hljs-number">0xff0000</span> unreachable<br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> <span class="hljs-number">172.27</span><span class="hljs-number">.72</span><span class="hljs-number">.101</span> lookup main  <span class="hljs-operator">&lt;</span><span class="hljs-comment">--</span><br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> <span class="hljs-number">172.27</span><span class="hljs-number">.62</span><span class="hljs-number">.101</span> lookup main  <span class="hljs-operator">&lt;</span><span class="hljs-comment">--</span><br><span class="hljs-number">5260</span>:   <span class="hljs-keyword">from</span> <span class="hljs-number">172.27</span><span class="hljs-number">.71</span><span class="hljs-number">.101</span> lookup main  <span class="hljs-operator">&lt;</span><span class="hljs-comment">--</span><br><span class="hljs-number">5270</span>:   <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup <span class="hljs-number">52</span><br><span class="hljs-number">32766</span>:  <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup main<br><span class="hljs-number">32767</span>:  <span class="hljs-keyword">from</span> <span class="hljs-keyword">all</span> lookup <span class="hljs-keyword">default</span><br></code></pre></td></tr></table></figure>
<p>同时，<code>logread</code> 中烦人的丢包日志也从此消失了。</p>
</div>
<div class="hexo-llm-en">

<p>To ensure network reliability, I run both Tailscale and ZeroTier on my OpenWrt router. I primarily use Tailscale, but ZeroTier serves as an excellent failover that works wonders when Tailscale struggles with connectivity.</p>
<h3 id="The-Symptom-Mysterious-Packet-Drop-Logs"><a href="#The-Symptom-Mysterious-Packet-Drop-Logs" class="headerlink" title="The Symptom: Mysterious Packet Drop Logs"></a>The Symptom: Mysterious Packet Drop Logs</h3><p>It all started with a seemingly minor anomaly. While checking the OpenWrt system logs, I noticed recurring error messages printed by <code>tailscaled</code> (the Tailscale daemon):</p>
<pre><code class="language-log">Fri Jul 11 21:10:43 2025 daemon.err tailscaled[3274]: Drop: IPProto-44&#123;[fd7a:...] &gt; [fd7a:...]&#125; ... unknown-protocol-44
Fri Jul 11 21:10:53 2025 daemon.err tailscaled[3274]: [RATELIMIT] format(&quot;%s: %s %d %s\n%s&quot;) (8 dropped)
</code></pre>
<p>The logs indicated that Tailscale was dropping packets of a protocol it didn’t recognize (<code>IPProto-44</code>). Both the source and destination IPs belonged to devices within my internal network. Even stranger, this traffic appeared unrelated to Tailscale itself. After some troubleshooting, I identified the culprit: these “abnormal” packets were actually generated by the ZeroTier client attempting to communicate with its Moon relay servers.</p>
<h3 id="Deep-Dive-It’s-the-Routing-Table"><a href="#Deep-Dive-It’s-the-Routing-Table" class="headerlink" title="Deep Dive: It’s the Routing Table"></a>Deep Dive: It’s the Routing Table</h3><p>Why was ZeroTier traffic leaking into Tailscale’s domain? The answer lies in the Linux routing rules.</p>
<p>By SSHing into the OpenWrt instance and running <code>ip rule show</code>, the root cause became clear:</p>
<pre><code class="language-bash">root@ImmortalWrt:~# ip rule show
0:      from all lookup local
...
5270:   from all lookup 52
32766:  from all lookup main
...
</code></pre>
<p>Linux routing rules are executed based on priority (<code>prio</code>), where a lower number indicates higher priority. This output reveals the following logic:<br>The system first checks if the traffic is destined for the router itself (<code>lookup local</code>). If not, it moves to the rule with priority <code>5270</code>. This rule states: “<strong>For all traffic, first check routing table 52</strong>.” Table <code>52</code> is a dedicated routing table created by Tailscale upon installation, which only contains routes to other Tailscale nodes. Only if no match is found in table <code>52</code> does the traffic proceed to the <code>main</code> routing table (where our standard internet gateway resides).</p>
<p><strong>The conclusion is obvious: Tailscale implements an “aggressive” high-priority rule that intercepts all outgoing traffic from the router, including ZeroTier’s. When ZeroTier’s specific signaling packets are forced into the Tailscale network, Tailscale—unfamiliar with the protocol—simply drops them.</strong></p>
<h3 id="The-Solution"><a href="#The-Solution" class="headerlink" title="The Solution"></a>The Solution</h3><p>To resolve this, we shouldn’t modify Tailscale’s rules directly, as they are managed by the daemon. Instead, we should establish a “dedicated bypass” for ZeroTier with an even higher priority.</p>
<p><strong>Our strategy:</strong> Create a new routing rule that explicitly tells the system: “<strong>Any traffic originating from a ZeroTier virtual interface must look up the <code>main</code> routing table directly</strong>,” ensuring this rule has a higher priority (a lower number) than Tailscale’s <code>5270</code>.</p>
<h4 id="Implementation-on-OpenWrt"><a href="#Implementation-on-OpenWrt" class="headerlink" title="Implementation on OpenWrt"></a>Implementation on OpenWrt</h4><h5 id="Step-1-Recommended-Install-the-Full-ip-Utility"><a href="#Step-1-Recommended-Install-the-Full-ip-Utility" class="headerlink" title="Step 1: (Recommended) Install the Full ip Utility"></a>Step 1: (Recommended) Install the Full <code>ip</code> Utility</h5><p>The default <code>ip</code> command in OpenWrt (provided by busybox) may lack certain features. Installing <code>ip-full</code> prevents various compatibility issues.</p>
<pre><code class="language-bash">opkg update
opkg install ip-full
</code></pre>
<h5 id="Step-2-Create-the-Service-Script"><a href="#Step-2-Create-the-Service-Script" class="headerlink" title="Step 2: Create the Service Script"></a>Step 2: Create the Service Script</h5><p>Create a new init script using <code>vi</code> or <code>nano</code>.</p>
<pre><code class="language-bash">nano /etc/init.d/zerotier-policy-route
</code></pre>
<p>Paste the following script into the file.</p>
<div class="note note-warning">
            <p>Please modify the <code>ZT_IFACE</code> variable to match your environment. You can find your ZeroTier interface name by running <code>ifconfig | grep zt</code>.</p> 
          </div>

<pre><code class="language-sh">#!/bin/sh /etc/rc.common

#
# This script creates policy routing rules for ZeroTier to coexist with Tailscale.
# It prevents ZeroTier&#39;s traffic from being intercepted by Tailscale&#39;s high-priority rule.
# Version 3: Intelligently handles IPv4 and IPv6 addresses.
#

START=99
STOP=15

# --- CONFIGURATION ---
# The name of your ZeroTier virtual network interface. Find it with `ifconfig | grep zt`.
ZT_IFACE=&quot;ztypia4gba&quot;

# The priority for the new routing rule. Must be lower (higher priority) than Tailscale&#39;s (usually 5270).
RULE_PRIO=&quot;5260&quot;

# Tag for system log entries.
LOG_TAG=&quot;zerotier-policy-route&quot;
# --- END CONFIGURATION ---

add_rules() &#123;
    # Get all global/unique IP addresses (v4 and v6), excluding link-local (fe80::) addresses.
    IP_LIST=$(ip addr show dev &quot;$&#123;ZT_IFACE&#125;&quot; | grep -E &#39;inet|inet6&#39; | grep -v &#39; fe80::&#39; | awk &#39;&#123;print $2&#125;&#39; | cut -d&#39;/&#39; -f1)

    if [ -z &quot;$&#123;IP_LIST&#125;&quot; ]; then
        logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Warning: No usable IP addresses found on interface $&#123;ZT_IFACE&#125;.&quot;
        return
    fi

    for ip in $&#123;IP_LIST&#125;; do
        # Check if a rule for this IP already exists to avoid duplication.
        if ! ip rule | grep -q &quot;from $&#123;ip&#125; lookup main&quot;; then
            logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Adding rule for $&#123;ip&#125; with priority $&#123;RULE_PRIO&#125;.&quot;
            
            # CRITICAL FIX: Use the &#39;-6&#39; flag for IPv6 addresses.
            if echo &quot;$&#123;ip&#125;&quot; | grep -q &quot;:&quot;; then
                ip -6 rule add from &quot;$&#123;ip&#125;&quot; lookup main prio &quot;$&#123;RULE_PRIO&#125;&quot;
            else
                ip rule add from &quot;$&#123;ip&#125;&quot; lookup main prio &quot;$&#123;RULE_PRIO&#125;&quot;
            fi
        else
            logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Rule for $&#123;ip&#125; already exists. Skipping.&quot;
        fi
    done
&#125;

remove_rules() &#123;
    IP_LIST=$(ip addr show dev &quot;$&#123;ZT_IFACE&#125;&quot; | grep -E &#39;inet|inet6&#39; | grep -v &#39; fe80::&#39; | awk &#39;&#123;print $2&#125;&#39; | cut -d&#39;/&#39; -f1)
    if [ -z &quot;$&#123;IP_LIST&#125;&quot; ]; then return; fi

    for ip in $&#123;IP_LIST&#125;; do
        if ip rule | grep -q &quot;from $&#123;ip&#125; lookup main&quot;; then
            logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Removing rule for $&#123;ip&#125;.&quot;

            # Use the &#39;-6&#39; flag for deletion of IPv6 rules as well.
            if echo &quot;$&#123;ip&#125;&quot; | grep -q &quot;:&quot;; then
                ip -6 rule del from &quot;$&#123;ip&#125;&quot; lookup main prio &quot;$&#123;RULE_PRIO&#125;&quot;
            else
                ip rule del from &quot;$&#123;ip&#125;&quot; lookup main prio &quot;$&#123;RULE_PRIO&#125;&quot;
            fi
        fi
    done
&#125;

start() &#123;
    logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Service starting, applying rules...&quot;
    add_rules
&#125;

stop() &#123;
    logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Service stopping, removing rules...&quot;
    remove_rules
&#125;

reload() &#123;
    logger -t &quot;$&#123;LOG_TAG&#125;&quot; &quot;Service reloading...&quot;
    stop
    start
&#125;
</code></pre>
<h5 id="Step-3-Authorize-and-Enable-the-Service"><a href="#Step-3-Authorize-and-Enable-the-Service" class="headerlink" title="Step 3: Authorize and Enable the Service"></a>Step 3: Authorize and Enable the Service</h5><p>After saving the file, execute the following commands in the terminal:</p>
<pre><code class="language-bash"># Grant execution permissions
chmod +x /etc/init.d/zerotier-policy-route

# Enable the service to run on boot
/etc/init.d/zerotier-policy-route enable

# Start the service immediately
/etc/init.d/zerotier-policy-route start
</code></pre>
<h5 id="Step-4-Verification"><a href="#Step-4-Verification" class="headerlink" title="Step 4: Verification"></a>Step 4: Verification</h5><p>Run <code>ip rule show</code>. You should see output similar to the following, where the <code>5260</code> rules for each ZeroTier IP are correctly positioned above Tailscale’s rules.</p>
<pre><code class="hljs">0:      from all lookup local
...
5260:   from 172.27.72.251 lookup main
5260:   from fddd:ec77:... lookup main
5260:   from fce1:9571:... lookup main
5270:   from all lookup 52
...
</code></pre>
<h4 id="Implementation-on-Linux-Servers"><a href="#Implementation-on-Linux-Servers" class="headerlink" title="Implementation on Linux Servers"></a>Implementation on Linux Servers</h4><p>Since these errors appeared on OpenWrt, it’s highly likely that another Linux server in your Tailscale network is also running both services. We can adapt the script for standard Linux distributions.</p>
<h5 id="Policy-Routing-Script"><a href="#Policy-Routing-Script" class="headerlink" title="Policy Routing Script"></a>Policy Routing Script</h5><pre><code class="language-bash">sudo nano /usr/local/sbin/zerotier-policy-route.sh
</code></pre>
<pre><code class="language-sh">#!/bin/bash

#
# This script creates policy routing rules for all ZeroTier interfaces
# to coexist with Tailscale on a standard Linux system.
#

set -e # Exit immediately if a command exits with a non-zero status.

# --- CONFIGURATION ---
# The priority for the new routing rule.
# This MUST be a lower number (higher priority) than Tailscale&#39;s rule (usually 5270).
RULE_PRIO=&quot;5260&quot;
LOG_TAG=&quot;zerotier-policy-route&quot;
# --- END CONFIGURATION ---

# Find all ZeroTier network interfaces (names starting with &#39;zt&#39;).
ZT_INTERFACES=$(ip -o link show | awk -F&#39;: &#39; &#39;&#123;print $2&#125;&#39; | grep &#39;^zt&#39;)

if [ -z &quot;$ZT_INTERFACES&quot; ]; then
    logger -t &quot;$LOG_TAG&quot; &quot;No ZeroTier interfaces found. Exiting.&quot;
    exit 0
fi

# Function to add rules for all found interfaces
add_rules() &#123;
    logger -t &quot;$LOG_TAG&quot; &quot;Applying policy routing rules...&quot;
    for iface in $ZT_INTERFACES; do
        # Get all global/unique IP addresses (v4 and v6), excluding link-local (fe80::)
        IP_LIST=$(ip addr show dev &quot;$iface&quot; | grep -E &#39;inet|inet6&#39; | grep -v &#39;fe80::&#39; | awk &#39;&#123;print $2&#125;&#39; | cut -d&#39;/&#39; -f1)
        
        if [ -z &quot;$IP_LIST&quot; ]; then
            logger -t &quot;$LOG_TAG&quot; &quot;No usable IP addresses on interface $iface. Skipping.&quot;
            continue
        fi

        for ip in $IP_LIST; do
            if ! ip rule | grep -q &quot;from $ip lookup main&quot;; then
                logger -t &quot;$LOG_TAG&quot; &quot;Adding rule for $ip (on $iface) with priority $RULE_PRIO.&quot;
                if [[ &quot;$ip&quot; == *&quot;:&quot;* ]]; then
                    ip -6 rule add from &quot;$ip&quot; lookup main prio &quot;$RULE_PRIO&quot;
                else
                    ip rule add from &quot;$ip&quot; lookup main prio &quot;$RULE_PRIO&quot;
                fi
            fi
        done
    done
&#125;

# Function to remove rules
remove_rules() &#123;
    logger -t &quot;$LOG_TAG&quot; &quot;Removing policy routing rules...&quot;
    while ip rule | grep -q &quot;prio $RULE_PRIO&quot;; do
        RULE_TO_DELETE=$(ip rule | grep &quot;prio $RULE_PRIO&quot; | head -n 1)
        logger -t &quot;$LOG_TAG&quot; &quot;Deleting rule: $RULE_TO_DELETE&quot;
        # We need to parse the rule string to delete it correctly
        ip rule del $(echo $&#123;RULE_TO_DELETE&#125; | sed &#39;s/[0-9]*:\s*//&#39;)
    done
&#125;

case &quot;$1&quot; in
    start)
        add_rules
        ;;
    stop)
        remove_rules
        ;;
    restart)
        remove_rules
        add_rules
        ;;
    *)
        echo &quot;Usage: $0 &#123;start|stop|restart&#125;&quot;
        exit 1
        ;;
esac

exit 0
</code></pre>
<p>Set the permissions:</p>
<pre><code class="language-bash">sudo chmod +x /usr/local/sbin/zerotier-policy-route.sh
</code></pre>
<h5 id="Systemd-Service-Unit"><a href="#Systemd-Service-Unit" class="headerlink" title="Systemd Service Unit"></a>Systemd Service Unit</h5><pre><code class="language-bash">sudo nano /etc/systemd/system/zerotier-policy-route.service
</code></pre>
<pre><code class="language-ini">[Unit]
Description=ZeroTier Policy Routing Fix for Tailscale Coexistence
After=network-online.target
Wants=network-online.target
After=zerotier-one.service tailscaled.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/sbin/zerotier-policy-route.sh start
ExecStop=/usr/local/sbin/zerotier-policy-route.sh stop

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Finally, enable and start the service:</p>
<pre><code class="language-bash">sudo systemctl enable zerotier-policy-route.service
sudo systemctl start zerotier-policy-route.service
</code></pre>
<p>Verify with <code>ip rule show</code>; you should see the entries mapped:</p>
<pre><code class="hljs">0:      from all lookup local
5210:   from all fwmark 0x80000/0xff0000 lookup main
...
5260:   from 172.27.72.101 lookup main  &lt;-- Fixed
5260:   from 172.27.62.101 lookup main  &lt;-- Fixed
5270:   from all lookup 52
...
</code></pre>
<p>With this setup, the annoying packet drop logs in <code>logread</code> will finally vanish.</p>
</div>
              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OpenWrt/" class="print-no-link">#OpenWrt</a>
      
        <a href="/tags/ZeroTier/" class="print-no-link">#ZeroTier</a>
      
        <a href="/tags/Tailscale/" class="print-no-link">#Tailscale</a>
      
        <a href="/tags/%E8%B7%AF%E7%94%B1%E5%86%B2%E7%AA%81/" class="print-no-link">#路由冲突</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44)</div>
      <div>https://tokisaki.top/blog/resolve-route-conflict-zerotier-tailscale/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Tokisaki Galaxy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月11日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/use-ipset-ban-chinaip/" title="在 Linux 上使用 ipset 高效屏蔽特定国家 IP（中国等）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">在 Linux 上使用 ipset 高效屏蔽特定国家 IP（中国等）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/refs-attention/" title="ReFS使用注意事项">
                        <span class="hidden-mobile">ReFS使用注意事项</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div class="cusdis" style="width:100%; overflow:visible; min-height:480px;">
    <div id="cusdis_thread"
      style="width:100%; overflow:visible;"
      data-host="https://cusdis.com"
      data-app-id="27923e0d-279d-4dad-bdc5-f1b12b6add4c"
      data-page-id="979decdc095c6e1114058aab45e09d83"
      data-page-url="blog/resolve-route-conflict-zerotier-tailscale/"
      data-page-title="Resolving Routing Conflicts Between Tailscale and ZeroTier on OpenWrt/Linux (IPProto-44)"
      data-theme="auto"
    >
    </div>
  </div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#cusdis_thread', function() {
      Fluid.utils.createScript('https://cusdis.com/js/widget/lang/zh-cn.js');
      Fluid.utils.createScript('https://cusdis.com/js/cusdis.es.js');

      // 取消容器滚动条，尝试让 iframe 展开显示
      var container = document.querySelector('.cusdis');
      var thread = document.querySelector('#cusdis_thread');
      if (container) container.style.overflow = 'visible';
      if (thread) thread.style.overflow = 'visible';

      // 等待 widget 加载后调整 iframe 样式
      setTimeout(function() {
        try {
          var iframe = thread && thread.querySelector('iframe');
          if (iframe) {
            iframe.style.width = '100%';
            iframe.style.border = 'none';
            iframe.style.overflow = 'visible';
            iframe.style.minHeight = '600px';
            iframe.setAttribute('scrolling', 'no');

            // 若同源，尝试根据内容自适应高度
            try {
              var doc = iframe.contentDocument || iframe.contentWindow.document;
              if (doc && doc.body) {
                iframe.style.height = doc.body.scrollHeight + 'px';
              }
            } catch (e) {
            }
          }
        } catch (e) {
        }
      }, 600);

      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema) {
        document.querySelector('#cusdis_thread').dataset.theme = schema
      }
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
<script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" integrity="sha256-XWzSUJ+FIQ38dqC06/48sNRwU1Qh3/afjmJ080SneA8=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" integrity="sha256-pMhcV6/TBDtqH9E9PWKgS+P32PVguLG8IipkPyqMtfY=" crossorigin="anonymous">

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


<script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" integrity="sha256-UVQ5HtHTmtqBT3KY5cd4AvI47pp0gJwIM+q45HD9oLk=" crossorigin="anonymous"></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://s4.zstatic.net/ajax/libs/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/TrymenT-ClocK/TrymenT-ClocK.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/TrymenT-ClocK/TrymenT-ClocK.min.js"></script><!-- hexo injector body_end end --></body>
</html>
